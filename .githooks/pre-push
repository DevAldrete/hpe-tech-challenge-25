#!/usr/bin/env bash
# Pre-push hook to run tests before pushing
# Install: Run `./setup-hooks.sh` or manually link this file

set -e

echo "ğŸ” Running pre-push checks..."

# Get the current branch
BRANCH=$(git symbolic-ref --short HEAD 2>/dev/null || echo "detached")
echo "ğŸ“Œ Current branch: $BRANCH"

# Check if we're pushing to main or release
PROTECTED_BRANCHES="main|release"
if echo "$BRANCH" | grep -qE "^($PROTECTED_BRANCHES)$"; then
    echo "âš ï¸  Pushing to protected branch '$BRANCH' - running full test suite"
    RUN_FULL_TESTS=true
else
    echo "âœ… Pushing to feature branch - running unit tests only"
    RUN_FULL_TESTS=false
fi

# Stash uncommitted changes to test only committed code
STASH_NAME="pre-push-$(date +%s)"
git stash save -u "$STASH_NAME" --quiet 2>/dev/null || true

# Function to restore stash on exit
cleanup() {
    if git stash list | grep -q "$STASH_NAME"; then
        echo "ğŸ“¦ Restoring stashed changes..."
        git stash pop --quiet 2>/dev/null || true
    fi
}
trap cleanup EXIT

echo ""
echo "ğŸ§ª Running tests..."

# Activate virtual environment if it exists
if [ -d ".venv" ]; then
    source .venv/bin/activate 2>/dev/null || true
fi

# Run unit tests
echo "  â†’ Running unit tests..."
if ! uv run pytest tests/unit/ -v --tb=short -m "unit" --quiet; then
    echo ""
    echo "âŒ Unit tests failed! Fix the issues before pushing."
    exit 1
fi

# Run full test suite for protected branches
if [ "$RUN_FULL_TESTS" = true ]; then
    echo "  â†’ Running integration tests..."
    if ! uv run pytest tests/integration/ -v --tb=short -m "integration" --quiet 2>/dev/null; then
        echo ""
        echo "âš ï¸  Integration tests had issues (continuing anyway)"
    fi
    
    echo "  â†’ Running linter..."
    if ! uv run ruff check . --quiet 2>/dev/null; then
        echo ""
        echo "âš ï¸  Linting issues detected (continuing anyway)"
    fi
fi

echo ""
echo "âœ… All pre-push checks passed!"
echo "ğŸš€ Pushing to remote..."

exit 0
